# 03_serverless_dash Resource Lineage

This document describes the resources created by the 03_serverless_dash provisioning process and their relationships to the foundational infrastructure established by 00_clientinfra.

## Architecture Overview

The 03_serverless_dash application builds upon the client provisioning foundation established by 00_clientinfra, inheriting core Azure tenant configurations while creating application-specific resources in the client's dedicated resource group.

## Resource Dependencies

### Inherited from 00_clientinfra

The following resources and configurations are **inherited** from the initial client provisioning process:

#### Core Azure Configuration
- **Azure Tenant ID**: `{AZURE_TENANT_ID}`
- **Azure Subscription ID**: `{AZURE_SUBSCRIPTION_ID}`
- **Master Provisioner Identity**: `client-provisioner` in `{MASTER_RESOURCE_GROUP}` RG

#### Client-Specific Foundation Resources
These resources are created by 00_clientinfra and **reused** by 03_serverless_dash:

| Resource | Name Pattern | Purpose | Created By |
|----------|--------------|---------|------------|
| Resource Group | `{CLIENT_NAME}-rg` | Client isolation boundary | 00_clientinfra |
| Storage Account | `{CLIENT_NAME,,}storage` | Customer data storage | 00_clientinfra |
| Blob Container | `{CLIENT_NAME}-in` | Input data container | 00_clientinfra |
| Blob Container | `{CLIENT_NAME}-out` | Output data container | 00_clientinfra |
| Key Vault | `{CLIENT_NAME}-kv` | Secrets management | 00_clientinfra |
| User Identity | `{APP_OWNER}` | Client admin user | 00_clientinfra |

#### Authentication & Permissions
- **Entra ID External Tenant**: User management and authentication
- **RBAC Assignments**: Storage Blob Data Contributor roles
- **Key Vault Access Policies**: Secret read/write permissions

### Created by 03_serverless_dash

The following resources are **newly created** by the 03_serverless_dash provisioning process:

#### Application-Specific Resources

| Resource Type | Resource Name | Purpose | Depends On |
|---------------|---------------|---------|------------|
| Managed Identity | `{CLIENT_NAME}-swa-identity` | Static Web App deployment identity | Resource Group |
| Azure Static Web App | `{CLIENT_NAME}-dashboard` | Quarto app hosting | Managed Identity |
| Federated Credentials | `github-federated-credential` | GitHub Actions authentication | Managed Identity |
| Federated Credentials | `github-federated-credential-master` | GitHub Actions authentication (master branch) | Managed Identity |

#### GitHub Integration

| Secret Name | Value Source | Purpose |
|-------------|--------------|---------|
| `{CLIENT_NAME}_AZURE_CLIENT_ID` | SWA Managed Identity | GitHub Actions authentication |
| `{CLIENT_NAME}_AZURE_TENANT_ID` | Inherited from 00_clientinfra | GitHub Actions authentication |
| `{CLIENT_NAME}_AZURE_SUBSCRIPTION_ID` | Inherited from 00_clientinfra | GitHub Actions authentication |
| `{CLIENT_NAME}_STORAGE_ACCOUNT_NAME` | From 00_clientinfra | Runtime data access |
| `{CLIENT_NAME}_STORAGE_SAS_TOKEN` | Generated by 03_serverless_dash | Secure blob access |
| `{CLIENT_NAME}_BLOB_CONTAINER_NAME` | From 00_clientinfra | Runtime data source |

## Data Flow Architecture

### Build-Time Data Flow
1. **GitHub Actions** pulls client configuration from GitHub secrets
2. **SAS Token** is retrieved from client's Key Vault (created by 00_clientinfra)
3. **Runtime Configuration** (`runtime-config.js`) is injected with blob storage credentials
4. **Quarto Build** processes the application with embedded configuration

### Runtime Data Flow
1. **User Request** → Azure Static Web App → Authentication (Entra ID)
2. **Observable.js Code** → `runtime-config.js` → Blob Storage SAS Token
3. **Data Fetch** → `{CLIENT_NAME}storage/{CLIENT_NAME}-in/customer_data.json`
4. **Visualization** → Observable Plot renders customer heatmap

## Security Model

### Authentication Chain
```
GitHub Actions → Federated Credential → SWA Managed Identity → Azure Resources
User Browser → Entra ID → Static Web App → SAS Token → Blob Storage
```

### Permission Boundaries
- **GitHub Actions**: Can deploy Static Web App, read Key Vault secrets
- **Static Web App**: Can generate SAS tokens, access blob storage
- **End Users**: Can authenticate via Entra ID, view application data
- **Client Admin**: Can manage app settings, upload data to blob storage

## Configuration Inheritance

### From Master Provisioner (00_clientinfra configs/*.env)
```bash
# Core Azure identity
AZURE_CLIENT_ID={MASTER_CLIENT_ID}
AZURE_TENANT_ID={AZURE_TENANT_ID}
AZURE_SUBSCRIPTION_ID={AZURE_SUBSCRIPTION_ID}

# Administrative
ADMIN_EMAIL={ADMIN_EMAIL}
ADMIN_IP={ADMIN_IP_ADDRESS}
ADMIN_OBJ={ADMIN_OBJECT_ID}
```

### Client-Specific (03_serverless_dash configs/*.env)
```bash
# Updated for 03_serverless_dash
REPO_NAME=Tidy-Analytics/03_serverless_dash
REPO_URL=https://github.com/Tidy-Analytics/03_serverless_dash

# Client application details
CLIENT_NAME={CLIENT_CODE}
CUSTOM_DOMAIN={CLIENT_CODE}.tidyanalytics.com
APP_OWNER={CLIENT_ADMIN_EMAIL}
APP_OWNER_NAME="{CLIENT_ADMIN_NAME}"
ORG_NAME="{CLIENT_ORGANIZATION}"
```

## Deployment Pipeline

### Stage 1: Foundation (00_clientinfra)
1. Create client resource group and base infrastructure
2. Set up storage accounts and containers
3. Configure Entra ID users and permissions
4. Store master credentials in Key Vault

### Stage 2: Pre-Provisioning (03_serverless_dash)
1. Load client configuration from 00_clientinfra setup
2. Create GitHub secrets for application deployment
3. Set up federated identity placeholders

### Stage 3: Main Provisioning (03_serverless_dash)
1. Create Static Web App managed identity
2. Configure federated credentials for GitHub Actions
3. Deploy Azure Static Web App
4. Update GitHub secrets with deployment tokens
5. Configure SAS tokens and blob access

### Stage 4: Application Deployment
1. GitHub Actions builds Quarto application
2. Inject runtime configuration with blob storage credentials
3. Deploy to Azure Static Web Apps
4. Configure custom domain and authentication

## Resource Naming Conventions

### From 00_clientinfra
- Resource Group: `{CLIENT_NAME}-rg`
- Storage Account: `{CLIENT_NAME,,}storage` (lowercase)
- Key Vault: `{CLIENT_NAME}-kv`
- Containers: `{CLIENT_NAME}-in`, `{CLIENT_NAME}-out`

### From 03_serverless_dash
- Managed Identity: `{CLIENT_NAME}-swa-identity`
- Static Web App: `{CLIENT_NAME}-dashboard`
- Custom Domain: `{CLIENT_NAME}.tidyanalytics.com`

## Cross-Repository Dependencies

### Code Dependencies
- **Configuration Pattern**: Inherits .env structure from 00_clientinfra
- **Provisioning Logic**: Adapts client-setup.sh patterns for Static Web Apps
- **Authentication Model**: Uses same Entra ID external tenant setup

### Data Dependencies
- **Customer Data**: Expected in `{CLIENT_NAME}-in` container (created by 00_clientinfra)
- **Secrets Management**: Uses Key Vault created by 00_clientinfra
- **User Management**: Uses Entra ID users created by 00_clientinfra

### Operational Dependencies
- **SAS Token Refresh**: Requires coordination with 00_clientinfra token management
- **User Access**: New users must be added via 00_clientinfra user provisioning
- **Domain Management**: Custom domains configured through 00_clientinfra DNS setup

## Evolution Path

### Current State
- 03_serverless_dash provides client-specific Quarto dashboard
- Built on foundation established by 00_clientinfra
- Uses inherited storage and authentication infrastructure

### Future Enhancements
- Additional Observable.js visualizations can be added to the Quarto framework
- Multiple client applications can share the same foundational infrastructure
- Advanced analytics features can leverage existing blob storage and Key Vault setup

## Troubleshooting Cross-Dependencies

### Common Issues
1. **SAS Token Expiration**: Tokens created by 03_serverless_dash expire every 7 days
2. **Permission Denied**: Check RBAC assignments created by 00_clientinfra
3. **Storage Access**: Verify container exists and was created by 00_clientinfra
4. **Authentication**: Ensure Entra ID external tenant is properly configured

### Resolution Path
1. Check 00_clientinfra provisioning completed successfully
2. Verify client configuration inheritance in 03_serverless_dash
3. Validate GitHub secrets match expected patterns
4. Test blob storage access with generated SAS tokens