[
  {
    "objectID": "heatmap.html",
    "href": "heatmap.html",
    "title": "Customer Segment Heatmap Analysis",
    "section": "",
    "text": "Code\nPlot = import(\"https://cdn.skypack.dev/@observablehq/plot@0.6\")\nd3 = import(\"https://cdn.skypack.dev/d3@7\")\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nCode\n// Load your pre-computed data\ncustomerData = FileAttachment(\"customer_data.json\").json()\n\n\n\n\n\n\n\n\n\nCode\n// Get unique segments for the dropdown\nsegments = [...new Set(customerData.map(d =&gt; d.segment_code))].sort()\n\n\n\n\n\n\n\n\n\nCode\n// Create the segment selector\nviewof selectedSegment = Inputs.select(segments, {\n  label: \"Select Customer Segment\",\n  value: segments[0]\n})\n\n\n\n\n\n\n\n\n\nCode\n// Filter data based on selection\nfilteredData = customerData.filter(d =&gt; d.segment_code === selectedSegment)\n\n\n\n\n\n\n\n\n\nCode\n// Calculate cohort averages for heatmap\ncohortAverages = d3.group(filteredData, d =&gt; d.customer_tenure_week, d =&gt; d.elapsed_week)\n\n\n\n\n\n\n\n\n\nCode\n// Transform grouped data into heatmap format\nheatmapData = Array.from(cohortAverages, ([tenure_week, elapsedData]) =&gt; \n  Array.from(elapsedData, ([elapsed_week, records]) =&gt; ({\n    customer_tenure_week: tenure_week,\n    elapsed_week: elapsed_week,\n    avg_amount: d3.mean(records, d =&gt; d.amount),\n    count: records.length\n  }))\n).flat()\n\n\n\n\n\n\n\n\n\nCode\n// Display summary statistics (hidden)\nsegmentSummary = ({\n  totalCustomers: [...new Set(filteredData.map(d =&gt; d.customer_id))].length,\n  totalObservations: filteredData.length,\n  avgAmount: d3.mean(filteredData, d =&gt; d.amount),\n  tenureWeeksRange: `${d3.min(filteredData, d =&gt; d.customer_tenure_week)} - ${d3.max(filteredData, d =&gt; d.customer_tenure_week)}`,\n  elapsedWeeksRange: `${d3.min(filteredData, d =&gt; d.elapsed_week)} - ${d3.max(filteredData, d =&gt; d.elapsed_week)}`\n})\n\n\n\n\n\n\n\n\n\nCode\n// Create the cohort heatmap visualization\nPlot.plot({\n  title: `${selectedSegment} Segment: Cohort Performance Over Time`,\n  //subtitle: \"Cohorts ordered chronologically (Week 1 = earliest onboarded customers)\",\n  width: 900,\n  height: 500,\n  marginLeft: 100,\n  marginBottom: 60,\n  style: {\n    backgroundColor: \"#f5f2e8\"\n  },\n  x: {\n    label: \"Elapsed Week →\",\n    domain: d3.range(1, 14),\n    tickFormat: d =&gt; `W${d}`,\n    padding: 0,\n    range: [0, 900 - 100] // Ensure full width usage\n  },\n  y: {\n    label: \"↑ Customer Tenure Week (Cohort)\",\n    domain: d3.range(1, 11), // Changed from .reverse() to show 1 at top\n    tickFormat: d =&gt; `Cohort ${d}`,\n    padding: 0,\n    range: [500 - 60, 0] // Ensure full height usage\n  },\n  color: {\n    type: \"linear\",\n    scheme: \"Blues\",\n    label: \"Average Amount ($)\",\n    legend: true\n  },\n  marks: [\n    Plot.rect(heatmapData, {\n      x: \"elapsed_week\",\n      y: \"customer_tenure_week\",\n      fill: \"avg_amount\",\n      title: d =&gt; `Cohort ${d.customer_tenure_week}, Week ${d.elapsed_week}\\nAvg Amount: $${d.avg_amount?.toFixed(2)}\\nObservations: ${d.count}`,\n      stroke: \"none\",\n      inset: 0\n    }),\n    Plot.text(heatmapData, {\n      x: \"elapsed_week\",\n      y: \"customer_tenure_week\",\n      text: d =&gt; d.avg_amount ? `$${d.avg_amount.toFixed(0)}` : \"\",\n      fill: \"white\",\n      fontSize: 10,\n      fontWeight: \"bold\"\n    })\n  ]\n})"
  }
]